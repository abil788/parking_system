{% extends "base.html" %}

{% block title %}Cards Management - Parking System{% endblock %}

{% block content %}
<div>
    <div class="flex justify-between items-center mb-8">
        <h1 class="text-3xl font-bold">Cards Management</h1>
        <button onclick="showAddModal()" class="bg-blue-500 hover:bg-blue-700 text-white font-bold py-2 px-4 rounded">
            + Add Card
        </button>
    </div>

    <!-- Search and Filter -->
    <div class="bg-white rounded-lg shadow p-4 mb-6">
        <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
            <input 
                type="text" 
                id="search" 
                placeholder="Search by UID, name, or plate..."
                class="border rounded px-3 py-2"
                onkeyup="searchCards()"
            >
            <select id="status-filter" class="border rounded px-3 py-2" onchange="searchCards()">
                <option value="">All Status</option>
                <option value="active">Active</option>
                <option value="blocked">Blocked</option>
                <option value="lost">Lost</option>
            </select>
        </div>
    </div>

    <!-- Cards Table -->
    <div class="bg-white rounded-lg shadow">
        <div class="overflow-x-auto">
            <table class="min-w-full">
                <thead class="bg-gray-50">
                    <tr>
                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Card UID</th>
                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Owner</th>
                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Vehicle</th>
                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Status</th>
                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Issued</th>
                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Expires</th>
                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Actions</th>
                    </tr>
                </thead>
                <tbody id="cards-tbody" class="bg-white divide-y divide-gray-200">
                    <tr>
                        <td colspan="7" class="px-6 py-4 text-center text-gray-500">Loading...</td>
                    </tr>
                </tbody>
            </table>
        </div>
        <div id="pagination" class="px-6 py-4 flex justify-between items-center border-t"></div>
    </div>
</div>

<!-- Add/Edit Modal -->
<div id="card-modal" class="hidden fixed inset-0 bg-gray-600 bg-opacity-50 overflow-y-auto h-full w-full">
    <div class="relative top-20 mx-auto p-5 border w-96 shadow-lg rounded-md bg-white">
        <h3 id="modal-title" class="text-lg font-bold mb-4">Add Card</h3>
        <form id="card-form">
            <input type="hidden" id="card-id">
            <div class="mb-4">
                <label class="block text-gray-700 text-sm font-bold mb-2">Card UID *</label>
                <input type="text" id="card-uid" required class="shadow border rounded w-full py-2 px-3">
            </div>
            <div class="mb-4">
                <label class="block text-gray-700 text-sm font-bold mb-2">Owner Name *</label>
                <input type="text" id="owner-name" required class="shadow border rounded w-full py-2 px-3">
            </div>
            <div class="mb-4">
                <label class="block text-gray-700 text-sm font-bold mb-2">Vehicle Plate *</label>
                <input type="text" id="vehicle-plate" required class="shadow border rounded w-full py-2 px-3">
            </div>
            <div class="mb-4">
                <label class="block text-gray-700 text-sm font-bold mb-2">Status</label>
                <select id="status" class="shadow border rounded w-full py-2 px-3">
                    <option value="active">Active</option>
                    <option value="blocked">Blocked</option>
                    <option value="lost">Lost</option>
                </select>
            </div>
            <div class="mb-4">
                <label class="block text-gray-700 text-sm font-bold mb-2">Expires At</label>
                <input type="datetime-local" id="expires-at" class="shadow border rounded w-full py-2 px-3">
            </div>
            <div class="mb-4">
                <label class="block text-gray-700 text-sm font-bold mb-2">Notes</label>
                <textarea id="notes" class="shadow border rounded w-full py-2 px-3" rows="3"></textarea>
            </div>
            <div class="flex justify-end gap-2">
                <button type="button" onclick="hideModal()" class="bg-gray-500 hover:bg-gray-700 text-white font-bold py-2 px-4 rounded">
                    Cancel
                </button>
                <button type="submit" class="bg-blue-500 hover:bg-blue-700 text-white font-bold py-2 px-4 rounded">
                    Save
                </button>
            </div>
        </form>
    </div>
</div>

<script>
    let currentPage = 1;
    const pageSize = 10;

    async function loadCards(page = 1) {
        const search = document.getElementById('search').value;
        const status = document.getElementById('status-filter').value;
        
        let url = `/cards?page=${page}&page_size=${pageSize}`;
        if (search) url += `&search=${encodeURIComponent(search)}`;
        if (status) url += `&status=${status}`;

        try {
            const response = await apiRequest(url);
            const data = await response.json();
            
            const tbody = document.getElementById('cards-tbody');
            if (data.cards.length === 0) {
                tbody.innerHTML = '<tr><td colspan="7" class="px-6 py-4 text-center text-gray-500">No cards found</td></tr>';
            } else {
                tbody.innerHTML = data.cards.map(card => `
                    <tr>
                        <td class="px-6 py-4 whitespace-nowrap">${card.card_uid}</td>
                        <td class="px-6 py-4">${card.owner_name}</td>
                        <td class="px-6 py-4">${card.vehicle_plate}</td>
                        <td class="px-6 py-4">
                            <span class="px-2 py-1 text-xs rounded ${getStatusClass(card.status)}">
                                ${card.status}
                            </span>
                        </td>
                        <td class="px-6 py-4">${new Date(card.issued_at).toLocaleDateString()}</td>
                        <td class="px-6 py-4">${card.expires_at ? new Date(card.expires_at).toLocaleDateString() : 'Never'}</td>
                        <td class="px-6 py-4">
                            <button onclick='editCard(${JSON.stringify(card)})' class="text-blue-600 hover:text-blue-900 mr-2">Edit</button>
                            <button onclick="deleteCard('${card.id}')" class="text-red-600 hover:text-red-900">Delete</button>
                        </td>
                    </tr>
                `).join('');
            }

            // Pagination
            renderPagination(data.page, Math.ceil(data.total / pageSize));
            currentPage = page;
        } catch (error) {
            console.error('Error loading cards:', error);
        }
    }

    function getStatusClass(status) {
        switch(status) {
            case 'active': return 'bg-green-100 text-green-800';
            case 'blocked': return 'bg-red-100 text-red-800';
            case 'lost': return 'bg-gray-100 text-gray-800';
            default: return 'bg-gray-100 text-gray-800';
        }
    }

    function renderPagination(current, total) {
        const pagination = document.getElementById('pagination');
        if (total <= 1) {
            pagination.innerHTML = '';
            return;
        }

        let html = '<div class="flex gap-2">';
        if (current > 1) {
            html += `<button onclick="loadCards(${current - 1})" class="px-3 py-1 border rounded hover:bg-gray-100">Previous</button>`;
        }
        html += `<span class="px-3 py-1">Page ${current} of ${total}</span>`;
        if (current < total) {
            html += `<button onclick="loadCards(${current + 1})" class="px-3 py-1 border rounded hover:bg-gray-100">Next</button>`;
        }
        html += '</div>';
        pagination.innerHTML = html;
    }

    function searchCards() {
        loadCards(1);
    }

    function showAddModal() {
        document.getElementById('modal-title').textContent = 'Add Card';
        document.getElementById('card-form').reset();
        document.getElementById('card-id').value = '';
        document.getElementById('card-uid').disabled = false;
        document.getElementById('card-modal').classList.remove('hidden');
    }

    function editCard(card) {
        document.getElementById('modal-title').textContent = 'Edit Card';
        document.getElementById('card-id').value = card.id;
        document.getElementById('card-uid').value = card.card_uid;
        document.getElementById('card-uid').disabled = true;
        document.getElementById('owner-name').value = card.owner_name;
        document.getElementById('vehicle-plate').value = card.vehicle_plate;
        document.getElementById('status').value = card.status;
        if (card.expires_at) {
            document.getElementById('expires-at').value = card.expires_at.substring(0, 16);
        }
        document.getElementById('notes').value = card.notes || '';
        document.getElementById('card-modal').classList.remove('hidden');
    }

    function hideModal() {
        document.getElementById('card-modal').classList.add('hidden');
    }

    document.getElementById('card-form').addEventListener('submit', async (e) => {
        e.preventDefault();
        
        const cardId = document.getElementById('card-id').value;
        const data = {
            card_uid: document.getElementById('card-uid').value,
            owner_name: document.getElementById('owner-name').value,
            vehicle_plate: document.getElementById('vehicle-plate').value,
            status: document.getElementById('status').value,
            expires_at: document.getElementById('expires-at').value || null,
            notes: document.getElementById('notes').value || null
        };

        try {
            let response;
            if (cardId) {
                // Update
                response = await apiRequest(`/cards/${cardId}`, {
                    method: 'PUT',
                    body: JSON.stringify(data)
                });
            } else {
                // Create
                response = await apiRequest('/cards', {
                    method: 'POST',
                    body: JSON.stringify(data)
                });
            }

            if (response.ok) {
                hideModal();
                loadCards(currentPage);
                alert(cardId ? 'Card updated successfully!' : 'Card created successfully!');
            } else {
                const error = await response.json();
                alert('Error: ' + (error.detail || 'Failed to save card'));
            }
        } catch (error) {
            alert('Error: ' + error.message);
        }
    });

    async function deleteCard(id) {
        if (!confirm('Are you sure you want to delete this card?')) return;

        try {
            const response = await apiRequest(`/cards/${id}`, {
                method: 'DELETE'
            });

            if (response.ok) {
                loadCards(currentPage);
                alert('Card deleted successfully!');
            } else {
                alert('Error deleting card');
            }
        } catch (error) {
            alert('Error: ' + error.message);
        }
    }

    loadCards();
</script>
{% endblock %}